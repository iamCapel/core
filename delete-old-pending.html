<!DOCTYPE html>
<html>
<head>
    <title>Borrar Reportes Pendientes Viejos</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBIwzALxUUNxYBdgGY7MoCNW_1DGdFhF-4",
            authDomain: "coredatabase-d6800.firebaseapp.com",
            projectId: "coredatabase-d6800",
            storageBucket: "coredatabase-d6800.firebasestorage.app",
            messagingSenderId: "692458314316",
            appId: "1:692458314316:web:6db509c83eaa1b52dfc652"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.deleteOldPending = async function() {
            try {
                console.log('üîç Buscando reportes pendientes...');
                const snapshot = await getDocs(collection(db, 'pendingReports'));
                
                console.log(`üì¶ Encontrados ${snapshot.size} reportes pendientes`);
                
                const reportes = [];
                snapshot.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    reportes.push({
                        id: docSnap.id,
                        timestamp: data.timestamp,
                        region: data.formData?.region || '',
                        provincia: data.formData?.provincia || '',
                        vehiculos: data.formData?.vehiculos?.length || 0,
                        data: data
                    });
                });
                
                // Ordenar por timestamp
                reportes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                console.log('üìã LISTA DE REPORTES:');
                reportes.forEach((r, i) => {
                    console.log(`${i + 1}. ${r.id}`);
                    console.log(`   Fecha: ${r.timestamp}`);
                    console.log(`   Regi√≥n: ${r.region || 'VAC√çO'}`);
                    console.log(`   Provincia: ${r.provincia || 'VAC√çO'}`);
                    console.log(`   Veh√≠culos: ${r.vehiculos}`);
                    console.log('');
                });
                
                // Borrar los viejos (todos menos el m√°s reciente)
                let deleted = 0;
                for (let i = 1; i < reportes.length; i++) {
                    console.log(`üóëÔ∏è Borrando VIEJO: ${reportes[i].id}`);
                    await deleteDoc(doc(db, 'pendingReports', reportes[i].id));
                    deleted++;
                }
                
                console.log(`‚úÖ ${deleted} reportes VIEJOS eliminados`);
                console.log(`‚úÖ Reporte m√°s reciente conservado: ${reportes[0].id}`);
                alert(`‚úÖ ${deleted} reportes viejos eliminados.\n‚úÖ Conservado: ${reportes[0].id}\n\nAhora recarga y abre el √∫nico pendiente que queda.`);
                
            } catch (error) {
                console.error('‚ùå Error eliminando reportes:', error);
                alert('Error: ' + error.message);
            }
        };

        console.log('‚úÖ Script cargado. Abre la consola y ejecuta: deleteOldPending()');
    </script>
</head>
<body style="font-family: Arial; padding: 40px; background: #f5f5f5;">
    <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h1 style="color: #e74c3c;">üóëÔ∏è Borrar Reportes Viejos</h1>
        
        <div style="background: #d1ecf1; border-left: 4px solid #0dcaf0; padding: 15px; margin: 20px 0;">
            <strong>‚ÑπÔ∏è SITUACI√ìN:</strong>
            <p>Tienes 2 reportes pendientes:</p>
            <ul>
                <li><strong>pending_1768402555229</strong> - NUEVO con datos ‚úÖ</li>
                <li><strong>pending_1768402262038</strong> - VIEJO vac√≠o ‚ùå</li>
            </ul>
            <p>Est√°s haciendo clic en el VIEJO, por eso carga vac√≠o.</p>
        </div>

        <h2>Instrucciones:</h2>
        <ol style="line-height: 2;">
            <li>Haz clic en el bot√≥n rojo abajo</li>
            <li>Esto borrar√° SOLO los reportes VIEJOS (vac√≠os)</li>
            <li>Dejar√° el m√°s reciente (con datos)</li>
            <li>Recarga la aplicaci√≥n</li>
            <li>Abre el √∫nico pendiente que qued√≥</li>
            <li>Ahora S√ç deber√≠a tener todos los datos</li>
        </ol>

        <button 
            onclick="deleteOldPending()" 
            style="background: #e74c3c; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-top: 20px;">
            üóëÔ∏è BORRAR REPORTES VIEJOS
        </button>

        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin-top: 30px;">
            <strong>‚úÖ Despu√©s de borrar:</strong>
            <p>1. Ve a la aplicaci√≥n</p>
            <p>2. Llena un formulario COMPLETO</p>
            <p>3. Haz clic en el bot√≥n NARANJA "Pendiente"</p>
            <p>4. Cierra el formulario</p>
            <p>5. Abre el pendiente de nuevo</p>
            <p>6. Ahora S√ç deber√≠a cargar con todos los datos</p>
        </div>
    </div>
</body>
</html>
